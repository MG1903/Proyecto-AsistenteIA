{% extends "base_panel.html" %}

{% block title %}Consultas | Panel IA{% endblock %}
{% block header_title %}Historial de consultas{% endblock %}
{% block header_subtitle %}
Registro de preguntas y respuestas procesadas por el asistente IA.
{% endblock %}

{% block content %}

<!-- TARJETAS SUPERIORES -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-white rounded-xl border border-slate-200 p-4">
    <p class="text-xs text-slate-500 mb-1">Consultas totales</p>
    <p class="text-2xl font-semibold">{{ total_consultas }}</p>
    <p class="text-[11px] text-slate-500 mt-1">
      Historial completo de interacciones.
    </p>
  </div>

  <div class="bg-white rounded-xl border border-slate-200 p-4">
    <p class="text-xs text-slate-500 mb-1">Consultas de hoy</p>
    <p class="text-2xl font-semibold">{{ consultas_hoy }}</p>
    <p class="text-[11px] text-slate-500 mt-1">
      Filtradas automáticamente por fecha actual.
    </p>
  </div>

  <div class="bg-white rounded-xl border border-slate-200 p-4">
    <p class="text-xs text-slate-500 mb-1">Tiempo promedio</p>
    <p class="text-2xl font-semibold">
      {% if avg_tiempo %}
        {{ avg_tiempo|floatformat:0 }} ms
      {% else %}
        —
      {% endif %}
    </p>
    <p class="text-[11px] text-slate-500 mt-1">
      Según las métricas registradas.
    </p>
  </div>
</div>

<!-- ENCABEZADO + BUSCADOR -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
  <div>
    <h2 class="text-sm font-semibold">Listado de consultas</h2>
    <p class="text-xs text-slate-500">
      Puedes buscar por texto de pregunta o respuesta.
    </p>
  </div>

  <form method="get" class="flex items-center gap-2">
    <input type="text"
           name="q"
           value="{{ busqueda }}"
           placeholder="Buscar en el historial..."
           class="border border-slate-300 rounded-full px-3 py-1.5 text-xs w-64
                  focus:outline-none focus:ring-1 focus:ring-brand">
    {% if busqueda %}
      <a href="{% url 'panel_consultas' %}"
         class="text-[11px] text-slate-500 hover:underline">Limpiar</a>
    {% endif %}
  </form>
</div>

<!-- TABLA DE CONSULTAS -->
<div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
  <table class="w-full text-xs">
    <thead class="bg-slate-50 border-b border-slate-200">
      <tr>
        <th class="text-left px-4 py-2 w-32">Fecha</th>
        <th class="text-left px-4 py-2">Pregunta</th>
        <th class="text-left px-4 py-2 hidden md:table-cell">Respuesta</th>
        <th class="text-left px-4 py-2 w-24">Tiempo (ms)</th>
        <th class="text-left px-4 py-2 w-20">Similitud V</th>
      </tr>
    </thead>
    <tbody>
      {% for c in consultas %}
        <tr class="border-b border-slate-100 hover:bg-slate-50/60">
          <td class="px-4 py-2 text-slate-600 align-top">
            {{ c.fecha|date:"d/m/Y" }}<br>
            <span class="text-[11px] text-slate-500">
              {{ c.fecha|time:"H:i" }}
            </span>
          </td>
          <td class="px-4 py-2 align-top">
            <p class="font-medium line-clamp-2 max-w-xs md:max-w-md">
              {{ c.texto_pregunta }}
            </p>
          </td>
          <td class="px-4 py-2 align-top hidden md:table-cell">
            <p class="text-slate-600 line-clamp-2 max-w-md">
              {{ c.texto_respuesta }}
            </p>
          </td>
          <td class="px-4 py-2 align-top">
            {% if c.tiempo_respuesta_ms %}
              {{ c.tiempo_respuesta_ms|floatformat:0 }}
            {% else %}
              <span class="text-slate-400">—</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 align-top">
            {% if c.precision_val %}
              {{ c.precision_val|floatformat:2 }}
            {% else %}
              <span class="text-slate-400">—</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5" class="px-4 py-6 text-center text-slate-500">
            No hay consultas registradas todavía.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
